# Tasks: AI-Powered Bargain Detection System

**Input**: Design documents from `/specs/001-ai-bargain-detection/`
**Prerequisites**: plan.md (required), spec.md (required for user stories), research.md, data-model.md, contracts/

**Tests**: Tests are OPTIONAL - only include them if explicitly requested in the feature specification.

**Organization**: Tasks are grouped by user story to enable independent implementation and testing of each story.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)
- Include exact file paths in descriptions

## Path Conventions

- **Web app**: `packages/web/src/` at repository root
- Paths shown below use `packages/web/src/` prefix

---

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Project initialization and basic structure

- [x] T001 [P] Verify project structure exists per implementation plan in `packages/web/`
- [x] T002 [P] Verify Next.js 16.0.10, React 19.2.0, and core dependencies are installed in `packages/web/package.json`
- [x] T003 [P] Configure TypeScript strict mode in `packages/web/tsconfig.json`
- [x] T004 [P] Setup ESLint and Prettier configuration in `packages/web/`
- [x] T005 [P] Configure environment variable management for Supabase, marketplace APIs, and OpenAI in `packages/web/.env.local.example`

---

## Phase 2: Foundational (Blocking Prerequisites)

**Purpose**: Core infrastructure that MUST be complete before ANY user story can be implemented

**‚ö†Ô∏è CRITICAL**: No user story work can begin until this phase is complete

- [x] T006 Verify Prisma schema exists and is up to date in `packages/web/prisma/schema.prisma` (schema already created)
- [ ] T007 Run Prisma migration to create database tables: `npm run db:migrate` in `packages/web/`
- [x] T008 Generate Prisma client and Zod schemas: `npm run db:generate` in `packages/web/`
- [x] T009 [P] Setup Supabase client for web in `packages/web/src/lib/supabase/client.ts` (verify exists)
- [x] T010 [P] Setup Supabase server client in `packages/web/src/lib/supabase/server.ts` (verify exists)
- [x] T011 [P] Setup Supabase auth helpers in `packages/web/src/lib/supabase/auth.ts` (verify exists)
- [x] T012 Create database query helpers using Supabase client (not Prisma) in `packages/web/src/lib/db/queries.ts`
- [x] T013 [P] Create type aliases for entities using Supabase autogenerated types in `packages/web/src/lib/db/types.ts` (export type aliases for Listing, Recommendation, SearchPreference, AIEvaluation, User, Notification using `Database['public']['Tables']['<table>']['Row']`, `Insert`, and `Update` patterns)
- [x] T014 [P] Setup API route structure and middleware in `packages/web/src/app/api/`
- [x] T015 [P] Configure error handling and logging infrastructure in `packages/web/src/lib/`
- [x] T016 Setup Supabase Row Level Security (RLS) policies for all tables (User, SearchPreference, Listing, AIEvaluation, Recommendation, Notification)

**Checkpoint**: Foundation ready - user story implementation can now begin in parallel

---

## Phase 3: User Story 1 - Receive Bargain Recommendations (Priority: P1) üéØ MVP

**Goal**: Users receive buy recommendations for listings that are likely undervalued, enabling them to purchase items at below-market prices.

**Independent Test**: Configure the system to search for items, evaluate them, and deliver recommendations to a test user account. The system delivers value even if only one marketplace is integrated or if recommendations are delivered via a simple list interface.

### Implementation for User Story 1

- [x] T017 [US1] Create Listing entity query functions using Supabase client in `packages/web/src/lib/db/queries.ts` (getListingById, createListing, updateListing)
- [x] T018 [US1] Create AIEvaluation entity query functions using Supabase client in `packages/web/src/lib/db/queries.ts` (createAIEvaluation, getEvaluationByListingId)
- [x] T019 [US1] Create Recommendation entity query functions using Supabase client in `packages/web/src/lib/db/queries.ts` (createRecommendation, getRecommendationsByUserId, getRecommendationById)
- [x] T020 [US1] Create Notification entity query functions using Supabase client in `packages/web/src/lib/db/queries.ts` (createNotification, getUnreadNotifications)
- [x] T021 [P] [US1] Create Amazon API client in `packages/web/src/lib/marketplace/amazon/client.ts`
- [x] T022 [P] [US1] Create eBay API client in `packages/web/src/lib/marketplace/ebay/client.ts`
- [x] T023 [P] [US1] Create Amazon API types in `packages/web/src/lib/marketplace/amazon/types.ts`
- [x] T024 [P] [US1] Create eBay API types in `packages/web/src/lib/marketplace/ebay/types.ts`
- [x] T025 [P] [US1] Create common marketplace types in `packages/web/src/lib/marketplace/types.ts`
- [x] T026 [US1] Create rate limiter for marketplace APIs in `packages/web/src/lib/marketplace/rate-limiter.ts`
- [x] T027 [US1] Implement Amazon search functionality in `packages/web/src/lib/marketplace/amazon/search.ts`
- [x] T028 [US1] Implement eBay search functionality in `packages/web/src/lib/marketplace/ebay/search.ts`
- [ ] T028a [US1] Implement Amazon getItemById functionality in `packages/web/src/lib/marketplace/amazon/client.ts` (required for URL-based evaluation)
- [ ] T028b [US1] Implement eBay getItemById functionality in `packages/web/src/lib/marketplace/ebay/client.ts` (required for URL-based evaluation)
- [ ] T029 [P] [US1] Create automated scanning evaluation logic (text-only optimized) in `packages/web/src/lib/ai/evaluate-scanning.ts`
- [x] T029a [P] [US1] Create user-provided listing evaluation logic (full multimodal) in `packages/web/src/lib/ai/evaluate-user-listing.ts`
- [ ] T030 [P] [US1] Create AI prompts (version-controlled) in `packages/web/src/lib/ai/prompts.ts` (include prompts for both text-only and multimodal workflows)
- [ ] T031 [P] [US1] Create AI evaluation types in `packages/web/src/lib/ai/types.ts` (include evaluation mode: "multimodal" | "text-only")
- [ ] T032 [US1] Implement recommendation service business logic in `packages/web/src/lib/recommendations/service.ts`
- [ ] T033 [US1] Implement notification delivery in `packages/web/src/lib/recommendations/notifications.ts`
- [ ] T034 [US1] Create POST /api/marketplace/search endpoint in `packages/web/src/app/api/marketplace/search/route.ts`
- [x] T035 [US1] Create POST /api/marketplace/evaluate endpoint in `packages/web/src/app/api/marketplace/evaluate/route.ts` (supports both workflows: user-provided with multimodal, automated scanning with text-only)
- [ ] T035a [US1] Implement URL parsing and fetching in `/api/marketplace/evaluate` endpoint (parseMarketplaceUrl and fetchListingFromUrl functions) - depends on T028a and T028b
- [ ] T036 [US1] Create GET /api/recommendations endpoint in `packages/web/src/app/api/recommendations/route.ts`
- [ ] T037 [US1] Create POST /api/recommendations endpoint in `packages/web/src/app/api/recommendations/route.ts`
- [ ] T038 [US1] Create recommendation list component in `packages/web/src/components/recommendations/recommendation-list.tsx`
- [ ] T039 [US1] Create recommendation card component in `packages/web/src/components/recommendations/recommendation-card.tsx`
- [ ] T040 [US1] Create recommendations list page in `packages/web/src/app/(dashboard)/recommendations/page.tsx`
- [ ] T041 [US1] Create use-recommendations hook in `packages/web/src/hooks/use-recommendations.ts`
- [ ] T042 [US1] Add validation using Zod schemas for all API request/response data in API routes

**Checkpoint**: At this point, User Story 1 should be fully functional and testable independently. Users can receive recommendations for undervalued listings.

---

## Phase 4: User Story 2 - Configure Search Preferences (Priority: P2)

**Goal**: Users can configure what types of items the system searches for and their price range preferences, so they only receive recommendations for items they're actually interested in purchasing.

**Independent Test**: Allow a user to set search preferences (categories, price ranges, keywords) and verify that only matching items are evaluated and recommended.

### Implementation for User Story 2

- [ ] T043 [US2] Create SearchPreference entity query functions using Supabase client in `packages/web/src/lib/db/queries.ts` (createPreference, getPreferencesByUserId, updatePreference, deletePreference)
- [ ] T044 [US2] Create GET /api/preferences endpoint in `packages/web/src/app/api/preferences/route.ts`
- [ ] T045 [US2] Create POST /api/preferences endpoint in `packages/web/src/app/api/preferences/route.ts`
- [ ] T046 [US2] Create PATCH /api/preferences/:id endpoint in `packages/web/src/app/api/preferences/[id]/route.ts`
- [ ] T047 [US2] Create DELETE /api/preferences/:id endpoint in `packages/web/src/app/api/preferences/[id]/route.ts`
- [ ] T048 [US2] Create preference form component in `packages/web/src/components/preferences/preference-form.tsx`
- [ ] T049 [US2] Create category selector component in `packages/web/src/components/preferences/category-selector.tsx`
- [ ] T050 [US2] Create preferences configuration page in `packages/web/src/app/(dashboard)/preferences/page.tsx`
- [ ] T051 [US2] Create use-preferences hook in `packages/web/src/hooks/use-preferences.ts`
- [ ] T052 [US2] Integrate preference filtering into marketplace search logic in `packages/web/src/lib/marketplace/amazon/search.ts` and `packages/web/src/lib/marketplace/ebay/search.ts`
- [ ] T053 [US2] Add validation using Zod schemas for preference API requests in `packages/web/src/app/api/preferences/route.ts`

**Checkpoint**: At this point, User Stories 1 AND 2 should both work independently. Users can configure preferences and receive filtered recommendations.

---

## Phase 5: User Story 3 - View Listing Details and Evaluation Reasoning (Priority: P2)

**Goal**: Users who received a recommendation can see detailed information about the listing and understand why the AI determined it's undervalued, enabling informed purchasing decisions.

**Independent Test**: Display a recommendation with all listing details, AI evaluation reasoning, confidence scores, and comparison data, allowing users to review and make decisions.

### Implementation for User Story 3

- [ ] T054 [US3] Create GET /api/recommendations/:id endpoint in `packages/web/src/app/api/recommendations/[id]/route.ts`
- [ ] T055 [US3] Create recommendation detail component in `packages/web/src/components/recommendations/recommendation-detail.tsx`
- [ ] T056 [US3] Create AI evaluation display component in `packages/web/src/components/recommendations/ai-evaluation-display.tsx`
- [ ] T057 [US3] Create recommendation detail page in `packages/web/src/app/(dashboard)/recommendations/[id]/page.tsx`
- [ ] T058 [US3] Add navigation from recommendation list to detail page in `packages/web/src/components/recommendations/recommendation-card.tsx`
- [ ] T059 [US3] Display listing images, description, seller information in recommendation detail component
- [ ] T060 [US3] Display AI evaluation reasoning, confidence scores, and factors in AI evaluation display component
- [ ] T061 [US3] Add link to original marketplace listing in recommendation detail component

**Checkpoint**: At this point, User Stories 1, 2, AND 3 should all work independently. Users can view detailed recommendation information with AI reasoning.

---

## Phase 6: User Story 4 - Manage Recommendations (Priority: P3)

**Goal**: Users can mark recommendations as viewed, dismissed, or purchased, so they can track which recommendations they've acted on and keep their recommendation list organized.

**Independent Test**: Allow users to interact with recommendations (mark as viewed, dismiss, mark as purchased) and verify that the system tracks these states correctly.

### Implementation for User Story 4

- [ ] T062 [US4] Create PATCH /api/recommendations/:id endpoint in `packages/web/src/app/api/recommendations/[id]/route.ts`
- [ ] T063 [US4] Create POST /api/recommendations/:id/mark-purchased endpoint in `packages/web/src/app/api/recommendations/[id]/mark-purchased/route.ts`
- [ ] T064 [US4] Update recommendation query functions to handle status updates in `packages/web/src/lib/db/queries.ts`
- [ ] T065 [US4] Add status update functionality to recommendation card component in `packages/web/src/components/recommendations/recommendation-card.tsx`
- [ ] T066 [US4] Add status update functionality to recommendation detail component in `packages/web/src/components/recommendations/recommendation-detail.tsx`
- [ ] T067 [US4] Add status filtering to recommendation list component in `packages/web/src/components/recommendations/recommendation-list.tsx`
- [ ] T068 [US4] Update use-recommendations hook to handle status updates in `packages/web/src/hooks/use-recommendations.ts`
- [ ] T069 [US4] Add validation using Zod schemas for status update requests in `packages/web/src/app/api/recommendations/[id]/route.ts`

**Checkpoint**: At this point, all user stories should be independently functional. Users can manage their recommendations effectively.

---

## Phase 7: Polish & Cross-Cutting Concerns

**Purpose**: Improvements that affect multiple user stories

- [ ] T070 [P] Add error handling and retry logic for marketplace API calls in `packages/web/src/lib/marketplace/amazon/client.ts` and `packages/web/src/lib/marketplace/ebay/client.ts`
- [ ] T071 [P] Implement API response caching for marketplace searches in `packages/web/src/lib/marketplace/`
- [ ] T072 [P] Add logging for all API interactions in `packages/web/src/lib/marketplace/` and `packages/web/src/lib/ai/`
- [ ] T072a [P] Integrate error tracking service (e.g., Sentry) in `packages/web/src/lib/errors.ts`
- [ ] T072b [P] Integrate logging service (e.g., LogRocket, Datadog) in `packages/web/src/lib/logger.ts`
- [ ] T073 [P] Create dashboard layout component in `packages/web/src/app/(dashboard)/layout.tsx`
- [ ] T074 [P] Create header component in `packages/web/src/components/layout/header.tsx`
- [ ] T075 [P] Create sidebar navigation component in `packages/web/src/components/layout/sidebar.tsx`
- [ ] T076 Implement notification system UI for new recommendations in `packages/web/src/components/`
- [ ] T077 Add loading states and error boundaries to all components
- [ ] T078 Add accessibility features (ARIA labels, keyboard navigation) to all interactive components
- [ ] T079 Optimize AI evaluation calls with batching and caching in `packages/web/src/lib/ai/evaluate-scanning.ts` (text-only workflow for bulk processing)
- [ ] T080 Add data validation and quality filtering for listings before evaluation in `packages/web/src/lib/marketplace/`
- [ ] T081 Implement duplicate listing detection across Amazon and eBay in `packages/web/src/lib/recommendations/service.ts`
- [ ] T082 Add handling for sold/unavailable listings in recommendation service
- [ ] T083 Run quickstart.md validation to ensure all setup steps work correctly

---

## Dependencies & Execution Order

### Phase Dependencies

- **Setup (Phase 1)**: No dependencies - can start immediately
- **Foundational (Phase 2)**: Depends on Setup completion - BLOCKS all user stories
- **User Stories (Phase 3+)**: All depend on Foundational phase completion
  - User stories can then proceed in parallel (if staffed)
  - Or sequentially in priority order (P1 ‚Üí P2 ‚Üí P3)
- **Polish (Final Phase)**: Depends on all desired user stories being complete

### User Story Dependencies

- **User Story 1 (P1)**: Can start after Foundational (Phase 2) - No dependencies on other stories
- **User Story 2 (P2)**: Can start after Foundational (Phase 2) - May integrate with US1 but should be independently testable
- **User Story 3 (P2)**: Depends on US1 (needs recommendations to exist) - Can start after US1 is complete
- **User Story 4 (P3)**: Depends on US1 (needs recommendations to exist) - Can start after US1 is complete

### Within Each User Story

- Database query functions before services
- Services before API endpoints
- API endpoints before UI components
- Core implementation before integration
- Story complete before moving to next priority
- Marketplace getItemById (T028a, T028b) before URL-based evaluation (T035a)

### Parallel Opportunities

- All Setup tasks marked [P] can run in parallel
- All Foundational tasks marked [P] can run in parallel (within Phase 2)
- Once Foundational phase completes, User Stories 1 and 2 can start in parallel
- User Story 3 and 4 can start after US1 completes
- All tests for a user story marked [P] can run in parallel
- Models/query functions within a story marked [P] can run in parallel
- Marketplace clients (Amazon, eBay) can be built in parallel
- AI evaluation logic can be built in parallel with marketplace integration

---

## Implementation Strategy

### MVP First (User Story 1 Only)

1. Complete Phase 1: Setup
2. Complete Phase 2: Foundational (CRITICAL - blocks all stories)
3. Complete Phase 3: User Story 1
4. **STOP and VALIDATE**: Test User Story 1 independently
5. Deploy/demo if ready

### Incremental Delivery

1. Complete Setup + Foundational ‚Üí Foundation ready
2. Add User Story 1 ‚Üí Test independently ‚Üí Deploy/Demo (MVP!)
3. Add User Story 2 ‚Üí Test independently ‚Üí Deploy/Demo
4. Add User Story 3 ‚Üí Test independently ‚Üí Deploy/Demo
5. Add User Story 4 ‚Üí Test independently ‚Üí Deploy/Demo
6. Each story adds value without breaking previous stories

### Parallel Team Strategy

With multiple developers:

1. Team completes Setup + Foundational together
2. Once Foundational is done:
   - Developer A: User Story 1 (marketplace integration + AI evaluation)
   - Developer B: User Story 2 (preferences) - can start in parallel
3. After US1 completes:
   - Developer A: User Story 3 (detail view)
   - Developer B: User Story 4 (status management)
4. Stories complete and integrate independently

---

## Notes

- [P] tasks = different files, no dependencies
- [Story] label maps task to specific user story for traceability
- Each user story should be independently completable and testable
- Commit after each task or logical group
- Stop at any checkpoint to validate story independently
- **IMPORTANT**: Use Supabase client for all data access operations (respects RLS). Prisma is only for migrations.
- **IMPORTANT**: Use Zod schemas (generated from Prisma models) to validate Supabase responses
- **IMPORTANT**: Use Supabase autogenerated types from `packages/web/src/lib/db/types.ts` for all database entity types. Create simple type aliases (e.g., `export type Listing = Database['public']['Tables']['listings']['Row']`) in the same file for cleaner imports throughout the codebase.
- Avoid: vague tasks, same file conflicts, cross-story dependencies that break independence

---

## Task Summary

- **Total Tasks**: 87
- **Phase 1 (Setup)**: 5 tasks
- **Phase 2 (Foundational)**: 11 tasks
- **Phase 3 (User Story 1 - MVP)**: 30 tasks (added T029a, T028a, T028b, T035a)
- **Phase 4 (User Story 2)**: 11 tasks
- **Phase 5 (User Story 3)**: 8 tasks
- **Phase 6 (User Story 4)**: 8 tasks
- **Phase 7 (Polish)**: 16 tasks (added T072a, T072b)

**Parallel Opportunities**: 
- Setup tasks: 5 parallel
- Foundational tasks: 8 parallel
- User Story 1: 17 parallel (marketplace clients, AI logic for both workflows, types)
- User Story 2: 6 parallel
- User Story 3: 4 parallel
- User Story 4: 4 parallel
- Polish tasks: 12 parallel

**Suggested MVP Scope**: User Story 1 only (30 tasks after foundational setup)

